<html>
<head>
  <script type="text/javascript" src="pf-segmentation.js"></script>
  <script type="text/javascript" src="segment-annotator.js"></script>
  <style type="text/css">
    body {
      font-family: Verdana, Arial, sans-serif;
    }
    .legend {
      display: inline-block;
    }
    .legend-item {
      display: inline-block;
      padding: .2em .5em;
      min-width: 8em;
      cursor: pointer;
      background-color: #eee;
    }
    .legend-item:hover {
      background-color: #999;
    }
    .legend-selected {
      background-color: #ccc;
    }
    .legend-delete-button {
      display: inline-block;
      padding: .2em .3em;
      cursor: pointer;
      background-color: #eee;
    }
    .legend-delete-button:hover {
      background-color: #999;
    }
    .legend-color-box {
      display: inline-block;
      border: #000 solid 1px;
      width: .8em;
      height: .8em;
      vertical-align: middle;
    }
    .toggle-button {
      display: inline-block;
      padding: .3em .5em;
      min-width: 6em;
      background-color: #eee;
      cursor: pointer;
    }
    .toggle-button:hover {
      background-color: #999;
    }
    .toggle-button-disabled {
      background-color: #ccc;
    }
  </style>
</head>
<body>
  <div style="white-space:nowrap;">
    <div id="annotator-container"></div>
    <div style="display:inline-block;vertical-align:top;padding:0 1em;">
      <p>Labels</p>
      <div id="legend" class="legend"></div>
      <p>
        <label for="add-label-input">Add:</label>
        <input id="add-label-input" type="text" style="width:6em;" />
      </p>
      <p>Views</p>
      <div>
        <div id="image-view-button" class="toggle-button">Image</div><br />
        <div id="boundary-view-button" class="toggle-button">Boundary</div><br />
        <div id="fill-view-button" class="toggle-button">Fill</div>
      </div>
      <p>Data</p>
      <div>
        <div id="import-button" class="toggle-button">Import</div><br />
        <div id="export-button" class="toggle-button">Export</div>
      </div>
    </div>
  </div>
  <script type="text/javascript">
    window.onload = function() {
      PFSegmentAnnotator('example.jpg', {
        sigma: 0.1,
        threshold: 300,
        min_size: 50,
        container: document.getElementById('annotator-container'),
        // annotation: 'annotation.png' // optional existing annotation data.
        labels: [
          {name: 'background', color: [255, 255, 255]},
          'skin',
          'skirt',
          'belt'
          ],
        callback: function(annotator) {
          initializeLegend(annotator);
          initializeLegendAdd(annotator);
          initializeButtons(annotator);
        }
      });
      // Create a legend.
      function initializeLegend(annotator) {
        // Attach a click event to a legend item.
        function attachClickEvent(item, i) {
          item.addEventListener('click', function() {
            var selected = document.getElementsByClassName('legend-selected')[0];
            if (selected)
              selected.classList.remove('legend-selected');
            annotator.setCurrentLabel(i);
            this.classList.add('legend-selected');
          });
        }
        var labels = annotator.getLabels();
        var legend = document.getElementById('legend');
        legend.innerHTML = '';
        for (var i = 0; i < labels.length; ++i) {
          // Create an item.
          var color = labels[i].color;
          var colorbox = document.createElement('span');
          colorbox.classList.add('legend-color-box');
          colorbox.style.backgroundColor =
              'rgb(' + color[0] + ',' + color[1] + ',' + color[2] + ')';
          var item = document.createElement('div');
          item.classList.add('legend-item');
          item.appendChild(colorbox);
          item.innerHTML += (' ' + labels[i].name);
          legend.appendChild(item);
          attachClickEvent(item, i);
          // Create a delete button.
          if (i !== 0) {
            var delete_button = document.createElement('div');
            delete_button.innerHTML = '&times;';
            delete_button.classList.add('legend-delete-button');
            legend.appendChild(delete_button);
            attachDeleteEvent(annotator, delete_button, i);
          }
          legend.appendChild(document.createElement('br'));
        }
        var current_index = Math.min(1, labels.length - 1);
        document.getElementsByClassName('legend-item')[current_index].click();
      }
      // Attach a click event to a delete button.
      function attachDeleteEvent(annotator, button, index) {
        button.addEventListener('click', function() {
          annotator.removeLabel(index);
          initializeLegend(annotator);
        });
      }
      // Add an item to the legend.
      function initializeLegendAdd(annotator) {
        var input = document.getElementById('add-label-input');
        input.addEventListener('keyup', function(event) {
          if (event.keyCode === 13) {
            var new_labels = annotator.getLabels();
            // Drop colors except the first.
            for (var i = 1; i < new_labels.length; ++i)
              new_labels[i] = new_labels[i].name;
            new_labels.push(event.target.value);
            annotator.setLabels(new_labels);
            initializeLegend(annotator);
            event.target.value = '';
            var index = new_labels.length - 1;
            document.getElementsByClassName('legend-item')[index].click();
          }
        });
      }
      // Create a slide radio input.
      function createToggleButton(button, disable_callback, enable_callback) {
        var enabled = true;
        button.addEventListener('click', function() {
          if (enabled) {
            disable_callback();
            button.classList.add('toggle-button-disabled');
            enabled = !enabled;
          }
          else {
            enable_callback();
            button.classList.remove('toggle-button-disabled');
            enabled = !enabled;
          }
        });
      }
      // Create a local file input.
      function createFileInput(button, callback) {
        var input = document.createElement('input');
        input.type = 'file';
        input.style.display = 'none';
        document.getElementsByTagName('body')[0].appendChild(input);
        input.addEventListener('change', function(event) {
          callback(event.target.files[0]);
        });
        button.addEventListener('click', function() {
          input.click();
        });
      }
      // Download as a file.      
      function downloadAsFile(url, filename) {
        var anchor = document.createElement('a');
        anchor.style.display = 'none';
        document.body.appendChild(anchor);
        anchor.setAttribute('href', url);
        anchor.setAttribute('download', filename);
        anchor.click();
        document.body.removeChild(anchor);
      };
      // Attach button events.
      function initializeButtons(annotator) {
        var fill_alpha = 128;
        var boundary_enabled = true;
        createToggleButton(document.getElementById('image-view-button'),
                           function() { annotator.setImageAlpha(0); },
                           function() { annotator.setImageAlpha(255); });
        createToggleButton(document.getElementById('boundary-view-button'), function() {
          annotator.setBoundaryAlpha(fill_alpha);
          boundary_enabled = !boundary_enabled;
        }, function() {
          if (fill_alpha === 128)
            annotator.setBoundaryAlpha(192);
          boundary_enabled = !boundary_enabled;
        });
        createToggleButton(document.getElementById('fill-view-button'), function() {
          fill_alpha = 0;
          annotator.setFillAlpha(fill_alpha);
          annotator.setBoundaryAlpha(fill_alpha);
        }, function() {
          fill_alpha = 128;
          annotator.setFillAlpha(fill_alpha);
          if (boundary_enabled)
            annotator.setBoundaryAlpha(192);
          else
            annotator.setBoundaryAlpha(fill_alpha);
        });
        // Set up json importer.
        createFileInput(document.getElementById('import-button'), function(file) {
          if (file.type === 'application/json') {
            var reader = new FileReader();
            reader.onload = function(event) {
              var data = JSON.parse(event.target.result);
              annotator.setLabels(data.labels);
              annotator.setAnnotation(data.annotation);
              initializeLegend(annotator);
            };
            reader.readAsText(file);
          }
        });
        document.getElementById('export-button').addEventListener('click', function() {
          var data = {
            labels: annotator.getLabels(),
            annotation: annotator.getAnnotation()
          };
          var data_url = 'data:application/json;charset=utf-8,' +
                         encodeURIComponent(JSON.stringify(data));
          downloadAsFile(data_url, 'export.json');
        });
      }
    }
  </script>
</body>
</html>